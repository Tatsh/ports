PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           cxx11 1.1

set gh_name         OpenRCT2
github.setup        ${gh_name} ${gh_name} 0.2.4 v
name                openrct2

categories          games
platforms           darwin linux freebsd
maintainers         {kencu @kencu} {gmail.com:audvare @Tatsh} openmaintainer
license             GPL-3+
revision            1

description         An open-source re-implementation of RollerCoaster Tycoon 2.
long_description    ${description} A construction and management simulation \
                    video game that simulates amusement park management. Requires \
                    files from the original RollerCoaster Tycoon 2 in order to work.

set tsv             0.1.2c
set objv            1.0.12
master_sites        ${github.homepage}/tarball/${git.branch}:main \
                    https://github.com/OpenRCT2/title-sequences/releases/download/v${tsv}:ts \
                    https://github.com/OpenRCT2/objects/releases/download/v${objv}:obj
distfiles           ${name}-${version}.tar.gz:main \
                    title-sequences.zip:ts \
                    objects.zip:obj
worksrcdir          ${gh_name}-${gh_name}-2603571

checksums           openrct2-0.2.4.tar.gz \
                    rmd160  e6f7d6930a27a904bbea04eef1c68e5b3a76cf52 \
                    sha256  6de0b8c964562201de473c4e073695ff3428a451a9cda3f95f85bfa2097bf5f7 \
                    size    6806232 \
                    title-sequences.zip \
                    rmd160  a0d44e1790a67e7400927fe567aa4814403ea5ee \
                    sha256  5284333fa501270835b5f0cf420cb52155742335f5658d7889ea35d136b52517 \
                    size    2980030 \
                    objects.zip \
                    rmd160  7176077b98478fb5f76ca3c628a24c069d733b85 \
                    sha256  1ddc6605878e32969d910aada5c49e789207d0122a8b0d8663492b4ff5b915fb \
                    size    2164242

# requires 10.11 or newer at present
# see https://trac.macports.org/ticket/55591
if {${os.platform} eq "darwin" && ${os.major} < 15} {
    pre-fetch {
        ui_error "${name} requires OS X 10.11 or later"
        return -code error "incompatible OS version"
    }
}

depends_build-append port:pkgconfig
depends_lib-append  port:libsdl2 \
                    path:lib/libssl.dylib:openssl \
                    port:jansson \
                    port:libpng \
                    port:libsdl2_ttf \
                    port:speexDSP \
                    port:libzip \
                    port:curl \
                    port:freetype \
                    port:libiconv \
                    port:icu
# prevent unctrl.h from loading - it brings in an error regarding undefined SCREEN*
# if MacPorts ncurses has been installed
configure.cppflags-append -DNCURSES_UNCTRL_H_incl
configure.cppflags-append -Wno-deprecated-declarations
configure.args-append \
    -DDOWNLOAD_TITLE_SEQUENCES=no \
    -DDOWNLOAD_OBJECTS=no

notes "
OpenRCT2 requires files from the original RollerCoaster Tycoon 2 in order to work.
"

post-extract {
    file mkdir ${worksrcpath}/data
    file mkdir ${worksrcpath}/data/title
    file mkdir ${worksrcpath}/data/object
    exec unzip ${distpath}/title-sequences.zip -d ${worksrcpath}/data/title/
    exec unzip ${distpath}/objects.zip -d ${worksrcpath}/data/object/
}

pre-patch {
    reinplace \
        "s|target_include_directories(\$\{PROJECT\} SYSTEM PRIVATE \$\{ICU.*|target_include_directories(\${PROJECT} BEFORE PRIVATE \${ICU_INCLUDE_DIRS})|" \
        ${worksrcpath}/src/${name}/CMakeLists.txt
}
