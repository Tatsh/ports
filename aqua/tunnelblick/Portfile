PortSystem          1.0
PortGroup           github 1.0
PortGroup           xcode 1.0

github.setup        Tunnelblick Tunnelblick 3.7.8 v

name                tunnelblick
version             3.7.8
categories          aqua net

depends_build-append    port:automake \
                        port:autoconf \
                        port:libtool
depends_run             port:openvpn2

worksrcdir          ${worksrcpath}/tunnelblick

checksums           rmd160  6b86e8059026b798f9d1b68b73368579bbbdfd4a \
                    sha256  ab7fbb4ce90049905b7e31f6e25044018bacac8149ebd22ced8f2787fc677362 \
                    size    60051244

xcode.target        Tunnelblick
xcode.configuration Release
xcode.build.settings \
    CODE_SIGN_IDENTITY=- \
    CODE_SIGN_STYLE=Manual
xcode.destroot.settings \
    CODE_SIGN_IDENTITY=- \
    CODE_SIGN_STYLE=Manual

patchfiles      001-project-adjustments.patch \
                002-null-updater.patch \
                003-sl-lproj.patch \
                004-paths.patch \
                005-signature.patch \
                006-daemon-ok.patch
patch.pre_args  -p2

# Compile and install in one step, for now. See https://trac.macports.org/ticket/57137
destroot.pre_args-append -UseModernBuildSystem=NO
build {}

post-destroot {
    set tools {atsystemstart installer openvpnstart process-network-changes \
               standardize-scutil-output tunnelblick-helper tunnelblickd}
    foreach tool $tools {
        if {! [file exists "${destroot}/${applications_dir}/Tunnelblick.app/Contents/Resources/${tool}"]} {
            file rename "${destroot}/${applications_dir}/${tool}" \
                "${destroot}/${applications_dir}/Tunnelblick.app/Contents/Resources/"
        }
        file delete -force "${destroot}/${applications_dir}/${tool}"
    }
}

if {${os.major} < 11} {
    pre-fetch {
        ui_error "${name} @${version} requires OS X 10.7 or later."
        return -code error "incompatible OS X version"
    }
}
