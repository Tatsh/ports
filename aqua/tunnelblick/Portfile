PortSystem          1.0
PortGroup           xcode 1.0

set version 3.1.8
master_sites        https://github.com/Tunnelblick/Tunnelblick/archive/
distfiles           v${version}.tar.gz

name                tunnelblick
version             ${version}
categories          aqua net
maintainers         {gmail.com:audvare @Tatsh}
description         Tool to manage OpenVPN settings.
long_description    ${description}
homepage            https://tunnelblick.net/
license             GPL-2

depends_build-append    port:automake \
                        port:autoconf \
                        port:libtool
depends_run             port:openvpn2

worksrcdir          ${worksrcpath}/tunnelblick

checksums           rmd160  b9d6705f2f9df69b6b7834d5dfb97642dbadef0b \
                    sha256  59e2368fb09674ba8d863c8552e2b0fbeab03e7fbd6b2a7a3ff0c4f7819137aa \
                    size    60764582

xcode.target        Tunnelblick
xcode.configuration Release
xcode.build.settings \
    CODE_SIGN_IDENTITY=- \
    CODE_SIGN_STYLE=Manual
xcode.destroot.settings \
    CODE_SIGN_IDENTITY=- \
    CODE_SIGN_STYLE=Manual

patchfiles      001-project-adjustments.patch \
                002-null-updater.patch \
                003-sl-lproj.patch \
                004-paths.patch \
                005-signature.patch \
                006-daemon-ok.patch
patch.pre_args  -p2

# Compile and install in one step, for now. See https://trac.macports.org/ticket/57137
destroot.pre_args-append -UseModernBuildSystem=NO
build {}

post-destroot {
    set tools {atsystemstart installer openvpnstart process-network-changes \
               standardize-scutil-output tunnelblick-helper tunnelblickd}
    foreach tool $tools {
        if {! [file exists "${destroot}/${applications_dir}/Tunnelblick.app/Contents/Resources/${tool}"]} {
            file rename "${destroot}/${applications_dir}/${tool}" \
                "${destroot}/${applications_dir}/Tunnelblick.app/Contents/Resources/"
        }
        file delete -force "${destroot}/${applications_dir}/${tool}"
    }
}

if {${os.major} < 11} {
    pre-fetch {
        ui_error "${name} @${version} requires OS X 10.7 or later."
        return -code error "incompatible OS X version"
    }
}
