# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
PortSystem          1.0

name                chromium
version             83.0.4103.23
categories          www
platforms           darwin
license             BSD
maintainers         {gmail.com:audvare @Tatsh}
description         Open-source version of Google Chrome web browser.
long_description    ${description}
homepage            https://chromium.org/
master_sites        https://commondatastorage.googleapis.com/chromium-browser-official/:chromium \
                    https://github.com/google/google-toolbox-for-mac/archive/:gtb
set gtb_version     2.2.2
distfiles           ${name}-${version}.tar.xz:chromium \
                    v${gtb_version}.tar.gz:gtb
supported_archs     x86_64
use_xz              yes:chromium no:gtb

checksums           chromium-83.0.4103.23.tar.xz \
                    rmd160  bbb1d416897153b4d371d4f96de34d7089069213 \
                    sha256  929a3d8c5da5066c496ddcc6147aa3c528976a61dca65c9010e625733fa46ee8 \
                    size    802566932 \
                    v2.2.2.tar.gz \
                    rmd160  645b3e1b4ed1d67856692433ccb2ff2c838db463 \
                    sha256  358f3970bcfa16e6cf0ae7d1b4a52104cd9f1348953a1d105b62ae699a602ec0 \
                    size    337736

depends_build-append \
    port:gn-devel \
    port:gzip \
    port:nodejs12 \
    port:python27 \
    port:yasm
depends_lib \
    port:bzip2 \
    port:expat \
    port:ffmpeg \
    port:flac \
    port:libjpeg-turbo \
    port:libvpx \
    port:libxslt \
    port:libxml2 \
    port:minizip \
    port:openjpeg \
    port:nspr \
    port:nss \
    port:re2 \
    port:snappy \
    port:zlib
# See README.md
use_xcode               yes
depends_build-append    port:clang-9.0

# These are my keys. You should get your own and set the appropriate
# environment variables.
# https://www.chromium.org/developers/how-tos/api-keys
set api_key     AIzaSyB_hqiMB2a3F0bS6zeKO6kLL9vDdV_G5v8
set client_id   764736492930-49m2gmgatl2basnvvc8887or3ufn5nvs.apps.googleusercontent.com
set secret      kdoszTi98YJNh3vT5pUW1b_Y

set python_bin  ${frameworks_dir}/Python.framework/Versions/2.7/bin
set python      ${python_bin}/python

configure.env-append    PATH=${python_bin}:$env(PATH)
configure.python        ${prefix}/bin/python2.7
configure.cmd           gn
configure.pre_args      gen
configure.post_args     --args=\'clang_use_chrome_plugins=false \
    closure_compile=true \
    enable_hangout_services_extension=true \
    enable_nacl=false \
    enable_widevine=true \
    fatal_linker_warnings=false \
    ffmpeg_branding=\"Chrome\" \
    fieldtrial_testing_like_official_build=true \
    google_api_key=\"${api_key}\" \
    google_default_client_id=\"${client_id}\" \
    google_default_client_secret=\"${secret}\" \
    is_clang=true \
    is_component_build=false \
    is_debug=false \
    proprietary_codecs=true \
    target_cpu=\"x64\" \
    treat_warnings_as_errors=false \
    use_cups=true \
    use_custom_libcxx=false \
    use_gnome_keyring=false \
    use_gold=false \
    use_lld=false \
    use_sysroot=false \
    use_system_lcms2=true \
    use_system_libjpeg=true \
    use_system_zlib=true\' \
    out/Release

build.env-append    PATH=${frameworks_dir}/Python.framework/Versions/2.7/bin:$env(PATH)
build.cmd           ninja
build.target        mksnapshot v8_context_snapshot_generator chrome chromedriver
build.pre_args      -v -C out/Release
build.args          ${build.target}

# second set comment: # gyp -> gn leftovers
set keeplibs {
    base/third_party/cityhash
    base/third_party/double_conversion
    base/third_party/dynamic_annotations
    base/third_party/icu
    base/third_party/nspr
    base/third_party/superfasthash
    base/third_party/symbolize
    base/third_party/valgrind
    base/third_party/xdg_mime
    base/third_party/xdg_user_dirs
    buildtools/third_party/libc++
    buildtools/third_party/libc++abi
    chrome/third_party/mozilla_security_manager
    courgette/third_party
    net/third_party/mozilla_security_manager
    net/third_party/nss
    net/third_party/quic
    net/third_party/uri_template
    third_party/abseil-cpp
    third_party/angle
    third_party/angle/src/common/third_party/base
    third_party/angle/src/common/third_party/smhasher
    third_party/angle/src/common/third_party/xxhash
    third_party/angle/src/third_party/compiler
    third_party/angle/src/third_party/libXNVCtrl
    third_party/angle/src/third_party/trace_event
    third_party/angle/src/third_party/volk
    third_party/angle/third_party/glslang
    third_party/angle/third_party/spirv-headers
    third_party/angle/third_party/spirv-tools
    third_party/angle/third_party/vulkan-headers
    third_party/angle/third_party/vulkan-loader
    third_party/angle/third_party/vulkan-tools
    third_party/angle/third_party/vulkan-validation-layers
    third_party/apple_apsl
    third_party/axe-core
    third_party/blink
    third_party/boringssl
    third_party/boringssl/src/third_party/fiat
    third_party/breakpad
    third_party/breakpad/breakpad/src/third_party/curl
    third_party/brotli
    third_party/cacheinvalidation
    third_party/catapult
    third_party/catapult/common/py_vulcanize/third_party/rcssmin
    third_party/catapult/common/py_vulcanize/third_party/rjsmin
    third_party/catapult/third_party/beautifulsoup4
    third_party/catapult/third_party/html5lib-python
    third_party/catapult/third_party/polymer
    third_party/catapult/third_party/six
    third_party/catapult/tracing/third_party/d3
    third_party/catapult/tracing/third_party/gl-matrix
    third_party/catapult/tracing/third_party/jpeg-js
    third_party/catapult/tracing/third_party/jszip
    third_party/catapult/tracing/third_party/mannwhitneyu
    third_party/catapult/tracing/third_party/oboe
    third_party/catapult/tracing/third_party/pako
    third_party/ced
    third_party/cld_3
    third_party/closure_compiler
    third_party/crashpad
    third_party/crashpad/crashpad/third_party/lss
    third_party/crashpad/crashpad/third_party/zlib
    third_party/crc32c
    third_party/cros_system_api
    third_party/dav1d
    third_party/dawn
    third_party/decklink
    third_party/depot_tools
    third_party/devscripts
    third_party/devtools-frontend
    third_party/devtools-frontend/src/front_end/third_party/fabricjs
    third_party/devtools-frontend/src/front_end/third_party/wasmparser
    third_party/devtools-frontend/src/third_party
    third_party/dom_distiller_js
    third_party/emoji-segmenter
    third_party/flatbuffers
    third_party/freetype
    third_party/libgifcodec
    third_party/glslang
    third_party/google_input_tools
    third_party/google_input_tools/third_party/closure_library
    third_party/google_input_tools/third_party/closure_library/third_party/closure
    third_party/googletest
    third_party/hunspell
    third_party/iccjpeg
    third_party/inspector_protocol
    third_party/jinja2
    third_party/jsoncpp
    third_party/jstemplate
    third_party/khronos
    third_party/leveldatabase
    third_party/libXNVCtrl
    third_party/libaddressinput
    third_party/libaom
    third_party/libaom/source/libaom/third_party/vector
    third_party/libaom/source/libaom/third_party/x86inc
    third_party/libjingle
    third_party/libphonenumber
    third_party/libsecret
    third_party/libsrtp
    third_party/libsync
    third_party/libudev
    third_party/libusb
    third_party/libwebm
    third_party/libwebp
    third_party/libxml
    third_party/libxml/chromium
    third_party/libyuv
    third_party/llvm
    third_party/lss
    third_party/lzma_sdk
    third_party/markupsafe
    third_party/mesa
    third_party/metrics_proto
    third_party/modp_b64
    third_party/mozilla
    third_party/nasm
    third_party/node
    third_party/node/node_modules/polymer-bundler/lib/third_party/UglifyJS2
    third_party/one_euro_filter
    third_party/openh264
    third_party/openscreen
    third_party/openscreen/src/third_party/tinycbor/src/src
    third_party/opus
    third_party/ots
    third_party/pdfium
    third_party/pdfium/third_party/agg23
    third_party/pdfium/third_party/base
    third_party/pdfium/third_party/bigint
    third_party/pdfium/third_party/freetype
    third_party/pdfium/third_party/lcms
    third_party/pdfium/third_party/libopenjpeg20
    third_party/pdfium/third_party/libpng16
    third_party/pdfium/third_party/libtiff
    third_party/pdfium/third_party/skia_shared
    third_party/perfetto
    third_party/pffft
    third_party/ply
    third_party/polymer
    third_party/private-join-and-compute
    third_party/protobuf
    third_party/protobuf/third_party/six
    third_party/pyjson5
    third_party/qcms
    third_party/rnnoise
    third_party/s2cellid
    third_party/simplejson
    third_party/skia
    third_party/skia/include/third_party/skcms
    third_party/skia/include/third_party/vulkan
    third_party/skia/third_party/libwebp
    third_party/skia/third_party/skcms
    third_party/skia/third_party/vulkan
    third_party/smhasher
    third_party/spirv-cross/spirv-cross
    third_party/spirv-headers
    third_party/SPIRV-Tools
    third_party/sqlite
    third_party/sudden_motion_sensor
    third_party/swiftshader
    third_party/swiftshader/third_party/llvm-7.0
    third_party/swiftshader/third_party/llvm-subzero
    third_party/swiftshader/third_party/marl
    third_party/swiftshader/third_party/subzero
    third_party/swiftshader/third_party/SPIRV-Headers/include/spirv/unified1
    third_party/unrar
    third_party/usrsctp
    third_party/vulkan
    third_party/web-animations-js
    third_party/webdriver
    third_party/webrtc
    third_party/webrtc/common_audio/third_party/fft4g
    third_party/webrtc/common_audio/third_party/spl_sqrt_floor
    third_party/webrtc/modules/third_party/fft
    third_party/webrtc/modules/third_party/g711
    third_party/webrtc/modules/third_party/g722
    third_party/webrtc/rtc_base/third_party/base64
    third_party/webrtc/rtc_base/third_party/sigslot
    third_party/widevine
    third_party/woff2
    third_party/wuffs
    third_party/zlib/google
    tools/grit/third_party/six
    url/third_party/mozilla
    v8/src/third_party/siphash
    v8/src/third_party/valgrind
    v8/src/third_party/utf8-decoder
    v8/third_party/inspector_protocol
    v8/third_party/v8

    base/third_party/libevent
    third_party/adobe
    third_party/speech-dispatcher
    third_party/usb_ids
    third_party/xdg-utils
    third_party/yasm/run_yasm.py

    third_party/expat
    third_party/icu
    third_party/crashpad/crashpad/third_party/apple_cf
    third_party/harfbuzz-ng

    third_party/angle/third_party/VK-GL-CTS/src/external/libpng
    third_party/angle/third_party/glmark2/src/src/libpng
    third_party/angle/third_party/libpng
    third_party/libpng
    third_party/skia/third_party/libpng
}
set gn_system_libraries {
    flac
    fontconfig
    libdrm
    libjpeg
    re2
    snappy
    yasm
    zlib
}

patch {
    exec ${python} ${worksrcpath}/build/linux/unbundle/remove_bundled_libraries.py \
        {*}${keeplibs} --do-remove
    file mkdir ${worksrcpath}/third_party/llvm-build/Release+Asserts/bin
    ln -s ${prefix}/bin/clang \
        ${worksrcpath}/third_party/llvm-build/Release+Asserts/bin/clang
    ln -s ${prefix}/bin/clang++ \
        ${worksrcpath}/third_party/llvm-build/Release+Asserts/bin/clang++
    file mkdir ${worksrcpath}/third_party/node/mac
    file mkdir ${worksrcpath}/third_party/node/mac/node-darwin-x64
    file mkdir ${worksrcpath}/third_party/node/mac/node-darwin-x64/bin
    ln -s ${prefix}/bin/node \
        ${worksrcpath}/third_party/node/mac/node-darwin-x64/bin/node
    move ${workpath}/google-toolbox-for-mac-${gtb_version} \
        ${worksrcpath}/third_party/google_toolbox_for_mac/src
    exec ${python} ${worksrcpath}/build/linux/unbundle/replace_gn_files.py \
        --system-libraries {*}${gn_system_libraries}
}

destroot {
    copy ${worksrcpath}/out/Release/Chromium.app \
        ${destroot}/${applications_dir}
}
