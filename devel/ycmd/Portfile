# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup            ycm-core ycmd 2ae3dd0
version                 20201217
revision                0
categories              devel textproc
platforms               darwin linux freebsd
license                 GPL-3
maintainers             {gmail.com:audvare @Tatsh}
description             A code-completion engine for Vim.
long_description        ${description}

checksums           rmd160  02a55e11b7a6654d217b6b4b332a9eeee66e0cef \
                    sha256  7c6b92a86f141f95df6e86e98deeff4dbeda628eae27c5ae095652898a9b87e3 \
                    size    3327805

worksrcdir  ${github.project}-${github.version}/cpp

set python_minor_version    8
set python_framework_dir    ${frameworks_dir}/Python.framework/Versions/3.${python_minor_version}
set site_packages_dir       ${python_framework_dir}/lib/python3.${python_minor_version}/site-packages
configure.pre_args-append \
    -DCMAKE_CXX_COMPILER=clang++
configure.args \
    -DPYTHON_LIBRARY=${python_framework_dir}/lib/libpython3.${python_minor_version}.dylib \
    -DPYTHON_INCLUDE_DIR=${python_framework_dir}/include/python3.${python_minor_version} \
    -DUSE_CLANG_TIDY=ON

set clang_version   11
set core_version    44

depends_lib \
    port:clang-${clang_version} \
    port:python3${python_minor_version}
depends_run \
    port:py3${python_minor_version}-bottle \
    port:py3${python_minor_version}-waitress \
    port:py3${python_minor_version}-regex \
    port:py3${python_minor_version}-jedi \
    port:py3${python_minor_version}-watchdog

patch.dir       ${worksrcpath}/..
patchfiles      gopls-path.patch \
                tern-path.patch \
                utils.patch \
                clangd-path.patch

post-patch {
    file delete -force ${patch.dir}/ycmd/tests
    file delete -force ${patch.dir}/third_party
    reinplace -W ${patch.dir} \
        "s|@LIBCLANG_DIR@|${prefix}/libexec/llvm-${clang_version}/lib|" \
        ycmd/utils.py
    reinplace -W ${patch.dir} "s|@CORE_VERSION@|${core_version}|" ycmd/utils.py
    reinplace -W ${patch.dir} "s|@LLVM_VERSION@|${clang_version}|" \
        ycmd/completers/cpp/clangd_completer.py
    reinplace -W ${patch.dir} "s|@PREFIX@|${prefix}|" \
        ycmd/completers/cpp/clangd_completer.py
    # Force finding clang-tidy in PATH
    reinplace "453s|NOT APPLE|APPLE|" ycm/CMakeLists.txt
}

post-build {
    # FIXME Hack rpath in for now
    system \
        "install_name_tool -rpath ${prefix}/lib ${prefix}/libexec/llvm-${clang_version}/lib ${worksrcpath}/../ycm_core.so"
    system "python -m compileall ${worksrcpath}/../ycmd"
}

destroot {
    xinstall -m 0755 -d ${destroot}${python_framework_dir}
    xinstall -m 0755 -d ${destroot}${python_framework_dir}/lib
    xinstall -m 0755 -d \
        ${destroot}${python_framework_dir}/lib/python3.${python_minor_version}
    xinstall -m 0755 -d ${destroot}${site_packages_dir}
    xinstall -m 0755 ${worksrcpath}/../ycm_core.so \
        ${destroot}${site_packages_dir}
    copy ${worksrcpath}/../ycmd ${destroot}${site_packages_dir}/
}
