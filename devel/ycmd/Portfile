# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup            ycm-core ycmd 29ba1e2
version                 20210121
revision                0
categories              devel textproc
platforms               darwin
license                 GPL-3
maintainers             {gmail.com:audvare @Tatsh}
description             A code-completion engine for Vim.
long_description        ${description}

checksums           rmd160  31121230a4aeb4fa9d0a838a991421849e831dba \
                    sha256  6b17937d763ddc06e7871c6991ceeae5bcf55d9bd799cf312d7a9cf1c599bfa7 \
                    size    3325578

worksrcdir  ${github.project}-${github.version}/cpp

set python_minor_version    8
set python_framework_dir    ${frameworks_dir}/Python.framework/Versions/3.${python_minor_version}
set site_packages_dir       ${python_framework_dir}/lib/python3.${python_minor_version}/site-packages
set ycm_core_file           ycm_core.cpython-3${python_minor_version}-darwin.so
configure.pre_args-append \
    -DCMAKE_CXX_COMPILER=clang++
configure.args \
    -DUSE_CLANG_TIDY=ON \
    -DPython3_ROOT_DIR=${python_framework_dir}

set clang_version   11
set core_version    44

depends_lib \
    port:clang-${clang_version} \
    port:python3${python_minor_version}
depends_run \
    port:py3${python_minor_version}-bottle \
    port:py3${python_minor_version}-waitress \
    port:py3${python_minor_version}-regex \
    port:py3${python_minor_version}-jedi \
    port:py3${python_minor_version}-watchdog

patch.dir       ${worksrcpath}/..
patchfiles      patch-gopls-path.diff \
                patch-tern-path.diff \
                patch-utils.diff \
                patch-clangd-path.diff

post-patch {
    file delete -force ${patch.dir}/ycmd/tests
    file delete -force ${patch.dir}/third_party
    reinplace -W ${patch.dir} \
        "s|@LIBCLANG_DIR@|${prefix}/libexec/llvm-${clang_version}/lib|" \
        ycmd/utils.py
    reinplace -W ${patch.dir} "s|@CORE_VERSION@|${core_version}|" ycmd/utils.py
    reinplace -W ${patch.dir} "s|@LLVM_VERSION@|${clang_version}|" \
        ycmd/completers/cpp/clangd_completer.py
    reinplace -W ${patch.dir} "s|@PREFIX@|${prefix}|" \
        ycmd/completers/cpp/clangd_completer.py
    # Force finding clang-tidy in PATH
    reinplace "423s|NOT APPLE|APPLE|" ycm/CMakeLists.txt
    # Force specific version of Python
    reinplace -E "s|Python3 \[0-9\\.\]+ REQUIRED COMPONENTS|Python3 3.8 EXACT REQUIRED COMPONENTS|" \
        CMakeLists.txt
}

post-build {
    # FIXME Hack rpath in for now
    system \
        "install_name_tool -rpath ${prefix}/lib ${prefix}/libexec/llvm-${clang_version}/lib ${worksrcpath}/../${ycm_core_file}"
    system "python -m compileall ${worksrcpath}/../ycmd"
}

destroot {
    xinstall -m 0755 -d ${destroot}${python_framework_dir}
    xinstall -m 0755 -d ${destroot}${python_framework_dir}/lib
    xinstall -m 0755 -d \
        ${destroot}${python_framework_dir}/lib/python3.${python_minor_version}
    xinstall -m 0755 -d ${destroot}${site_packages_dir}
    xinstall -m 0755 ${worksrcpath}/../${ycm_core_file} \
        ${destroot}${site_packages_dir}
    copy ${worksrcpath}/../ycmd ${destroot}${site_packages_dir}/
}
