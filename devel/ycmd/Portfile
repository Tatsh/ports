# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup            ycm-core ycmd a472855
version                 20211128
revision                0
categories              devel textproc
platforms               darwin
license                 GPL-3
maintainers             {gmail.com:audvare @Tatsh}
description             A code-completion engine for Vim.
long_description        {*}${description}

checksums           rmd160  52ce34f02ee4db9bf7c8f38bf3bb56dcd16c1b3f \
                    sha256  5a5ffe6a0db3c4f6d9422719eff524719bb8853d138758266df10e6a0c1af290 \
                    size    2953216

worksrcdir  ${github.project}-${github.version}/cpp

set python_minor_version    9
set python_framework_dir    ${frameworks_dir}/Python.framework/Versions/3.${python_minor_version}
set site_packages_dir       ${python_framework_dir}/lib/python3.${python_minor_version}/site-packages
set ycm_core_file           ycm_core.cpython-3${python_minor_version}-darwin.so
set clang_version           11
configure.compiler          macports-clang-${clang_version}
compiler.cxx_standard       2017
cmake.install_rpath-append  ${prefix}/libexec/llvm-${clang_version}/lib
configure.args-append \
    -DUSE_CLANG_TIDY=ON \
    -DPython3_ROOT_DIR=${python_framework_dir}

set core_version    45

depends_lib-append      port:python3${python_minor_version}
depends_run-append \
    port:py3${python_minor_version}-bottle \
    port:py3${python_minor_version}-waitress \
    port:py3${python_minor_version}-regex \
    port:py3${python_minor_version}-jedi \
    port:py3${python_minor_version}-watchdog

patch.dir       ${worksrcpath}/..
patchfiles      patch-gopls-path.diff \
                patch-tern-path.diff \
                patch-utils.diff \
                patch-clangd-path.diff \
                patch-clang-tidy.diff

post-patch {
    delete ${patch.dir}/ycmd/tests
    delete ${patch.dir}/third_party
    reinplace -W ${patch.dir} \
        "s|@LIBCLANG_DIR@|${prefix}/libexec/llvm-${clang_version}/lib|" \
        ycmd/utils.py
    reinplace -W ${patch.dir} "s|@CORE_VERSION@|${core_version}|" ycmd/utils.py
    reinplace -W ${patch.dir} "s|@LLVM_VERSION@|${clang_version}|" \
        ycmd/completers/cpp/clangd_completer.py
    reinplace -W ${patch.dir} "s|@PREFIX@|${prefix}|" \
        ycmd/completers/cpp/clangd_completer.py
    # Force specific version of Python
    reinplace -E "s|Python3 \[0-9\\.\]+ REQUIRED COMPONENTS|Python3 3.${python_minor_version} EXACT REQUIRED COMPONENTS|" \
        CMakeLists.txt
}

post-build {
    system "python -m compileall ${worksrcpath}/../ycmd"
}

destroot {
    xinstall -m 0755 -d ${destroot}${python_framework_dir}
    xinstall -m 0755 -d ${destroot}${python_framework_dir}/lib
    xinstall -m 0755 -d \
        ${destroot}${python_framework_dir}/lib/python3.${python_minor_version}
    xinstall -m 0755 -d ${destroot}${site_packages_dir}
    xinstall -m 0755 ${worksrcpath}/../${ycm_core_file} \
        ${destroot}${site_packages_dir}
    copy ${worksrcpath}/../ycmd ${destroot}${site_packages_dir}/
}
