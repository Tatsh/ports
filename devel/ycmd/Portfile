# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup            ycm-core ycmd 64a4eaf
version                 20201125
categories-append       textproc
maintainers             {gmail.com:audvare @Tatsh}
description             A code-completion engine for Vim.
long_description        ${description}

checksums           rmd160  6416f266f87e9cf5c10d5bce6d3f91af98befad6 \
                    sha256  b977699f09a6b7b9800f5faa8b1603efb78094d2fc811b4746b6f928494a21f0 \
                    size    3327358

worksrcdir  ${github.project}-${github.version}/cpp

set python_minor_version    8
set python_framework_dir    ${frameworks_dir}/Python.framework/Versions/3.${python_minor_version}
set site_packages_dir       ${python_framework_dir}/lib/python3.${python_minor_version}/site-packages
configure.pre_args-append \
    -DCMAKE_CXX_COMPILER=clang++
configure.args \
    -DUSE_CLANG_COMPLETER=ON \
    -DUSE_SYSTEM_LIBCLANG=ON \
    -DPYTHON_LIBRARY=${python_framework_dir}/lib/libpython3.${python_minor_version}.dylib \
    -DPYTHON_INCLUDE_DIR=${python_framework_dir}/include/python3.${python_minor_version}

set clang_version   10
set core_version    44

depends_lib \
    port:clang-${clang_version} \
    port:python3${python_minor_version}
depends_run \
    port:py3${python_minor_version}-bottle \
    port:py3${python_minor_version}-waitress \
    port:py3${python_minor_version}-regex \
    port:py3${python_minor_version}-jedi \
    port:py3${python_minor_version}-watchdog

patch.dir       ${worksrcpath}/..
patchfiles      gopls-path.patch \
                tern-path.patch \
                utils.patch

post-patch {
    file delete -force ${patch.dir}/ycmd/tests
    file delete -force ${patch.dir}/third_party
    reinplace -W ${patch.dir} \
        "s|@LIBCLANG_DIR@|${prefix}/libexec/llvm-${clang_version}/lib|" \
        ycmd/utils.py
    reinplace -W ${patch.dir} "s|@CORE_VERSION@|${core_version}|" ycmd/utils.py
}

post-build {
    # FIXME Hack rpath in for now
    system \
        "install_name_tool -rpath ${prefix}/lib ${prefix}/libexec/llvm-${clang_version}/lib ${worksrcpath}/../ycm_core.so"
    system "python -m compileall ${worksrcpath}/../ycmd"
}

destroot {
    xinstall -m 0755 -d ${destroot}${python_framework_dir}
    xinstall -m 0755 -d ${destroot}${python_framework_dir}/lib
    xinstall -m 0755 -d \
        ${destroot}${python_framework_dir}/lib/python3.${python_minor_version}
    xinstall -m 0755 -d ${destroot}${site_packages_dir}
    xinstall -m 0755 ${worksrcpath}/../ycm_core.so \
        ${destroot}${site_packages_dir}
    copy ${worksrcpath}/../ycmd ${destroot}${site_packages_dir}/
}
