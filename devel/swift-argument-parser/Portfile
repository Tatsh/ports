# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

github.setup            apple swift-argument-parser 1.7.0
# Use archive URL so fetch works (codeload can return 403)
github.tarball_from     archive
master_sites            ${github.homepage}/archive/
distfiles               1.7.0.tar.gz
distname                swift-argument-parser-1.7.0
categories              devel
platforms               darwin
license                 Apache-2.0
maintainers             {gmail.com:audvare @Tatsh}
homepage                https://github.com/apple/swift-argument-parser
description             Straightforward, type-safe argument parsing for Swift
long_description        {*}${description}

checksums           rmd160  57f9dfaa480c5634068015a2b16ddea8b6f8af2a \
                    sha256  84e685f0ca4d069a60193c9e477b6ec5a44016dc789db01e0b17c38b400a922e \
                    size    695009

cmake.generator Ninja
configure.args-append -DBUILD_EXAMPLES=NO -DBUILD_TESTING=NO

# 1.7.0 uses "internal import os" (Swift 6); patch to plain import for Swift 5.9
# Install ArgumentParserToolInfo.swiftmodule for clients (e.g. dockutil)
patchfiles patch-mutex-import.diff patch-install-toolinfo.diff
patch.pre_args -p0

post-destroot {
    # Create symlinks in lib/ if dylibs are only in lib/swift/macosx/ (e.g. older releases)
    if {![file exists ${destroot}${prefix}/lib/libArgumentParser.dylib]} {
        ln -s ${prefix}/lib/swift/macosx/libArgumentParser.dylib ${destroot}${prefix}/lib/
    }
    if {![file exists ${destroot}${prefix}/lib/libArgumentParserToolInfo.dylib]} {
        ln -s ${prefix}/lib/swift/macosx/libArgumentParserToolInfo.dylib ${destroot}${prefix}/lib/
    }
    # Copy ToolInfo swiftmodule to swift/macosx so clients need only one -I path
    set toolinfo_src ${destroot}${prefix}/lib/swift_static/macosx/ArgumentParserToolInfo.swiftmodule
    set toolinfo_dst ${destroot}${prefix}/lib/swift/macosx/ArgumentParserToolInfo.swiftmodule
    if {[file exists $toolinfo_src] && ![file exists $toolinfo_dst]} {
        file copy -force $toolinfo_src $toolinfo_dst
    }
}
