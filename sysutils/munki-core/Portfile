PortSystem          1.0
PortGroup           github 1.0

set ver             3.6.1
github.setup        munki munki ${ver} v

name                munki-core
version             ${ver}
license             Apache-2
description         Managed software installation for macOS (core).
long_description    Munki is a set of tools that, used together with a webserver-based \
                    repository of packages and package metadata, can be used by macOS \
                    administrators to manage software installs (and in many cases removals) on \
                    macOS client machines.

checksums           rmd160  871f37ee384c765d72eb513a8bab9dd20b195220 \
                    sha256  a4fb9fd7342d0338ac8199d4dba4b3636135d75c5c64b125efbb0d5b3f48a4b2 \
                    size    7443172

worksrcdir          "munki-${version}/code/client"

use_configure       no

build {}

destroot.violate_mtree  yes

destroot {
    # https://github.com/munki/munki/blob/master/code/tools/make_munki_mpkg.sh#L323
    set tools {authrestartd launchapp logouthelper managedsoftwareupdate supervisor \
        precache_agent ptyexec removepackages}
    foreach tool $tools {
        xinstall -m 755 "${worksrcpath}/$tool" "${destroot}${prefix}/bin"
    }
    # https://github.com/munki/munki/blob/master/code/tools/make_munki_mpkg.sh#L382
    set tools {makecatalogs makepkginfo manifestutil munkiimport iconimporter}
    foreach tool $tools {
        xinstall -m 755 "${worksrcpath}/$tool" "${destroot}${prefix}/bin"
    }
    # https://github.com/munki/munki/blob/master/code/tools/make_munki_mpkg.sh#L327
    file copy "${worksrcpath}/munkilib" "${destroot}${prefix}/lib/"
    # https://github.com/munki/munki/blob/master/code/tools/make_munki_mpkg.sh#L354
    xinstall -d -m 755 "/Library/Managed Installs"
    xinstall -d -m 750 "/Library/Managed Installs/Cache"
    xinstall -d -m 750 "/Library/Managed Installs/catalogs"
    xinstall -d -m 755 "/Library/Managed Installs/manifests"
}
