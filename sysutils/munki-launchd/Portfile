PortSystem          1.0
PortGroup           github 1.0

github.setup        munki munki 3.6.1 v

name                munki-launchd
license             Apache-2
description         Managed software installation for macOS (launchd).
long_description    Munki is a set of tools that, used together with a webserver-based \
                    repository of packages and package metadata, can be used by macOS \
                    administrators to manage software installs (and in many cases removals) on \
                    macOS client machines.

checksums           rmd160  871f37ee384c765d72eb513a8bab9dd20b195220 \
                    sha256  a4fb9fd7342d0338ac8199d4dba4b3636135d75c5c64b125efbb0d5b3f48a4b2 \
                    size    7443172

depends_run         port:munki-core

worksrcdir          "munki-${version}/launchd"

set agent_prefix com.googlecode.munki
set agents {com.googlecode.munki.ManagedSoftwareCenter.plist \
            com.googlecode.munki.MunkiStatus.plist \
            com.googlecode.munki.managedsoftwareupdate-loginwindow.plist \
            com.googlecode.munki.munki-notifier.plist}
set daemons {com.googlecode.munki.authrestartd.plist \
             com.googlecode.munki.logouthelper.plist \
             com.googlecode.munki.managedsoftwareupdate-check.plist \
             com.googlecode.munki.managedsoftwareupdate-install.plist \
             com.googlecode.munki.managedsoftwareupdate-manualcheck.plist}

use_configure       no

patch {
    foreach agent $agents {
        reinplace "s|/usr/local/munki/|/opt/local/bin/|g" LaunchAgents/$agent
        reinplace "s|/Applications/|/Applications/MacPorts/|g" LaunchAgents/$agent
    }
    foreach daemon $daemons {
        reinplace "s|/usr/local/munki/|/opt/local/bin/|g" LaunchDaemons/$daemon
        reinplace "s|/Applications/|/Applications/MacPorts/|g" LaunchDaemons/$daemon
    }
}

build {}

destroot {
    set launchd_label           org.macports.munki
    set agents_path_prefix      "${prefix}/etc/LaunchAgents/${launchd_label}"
    set daemons_path_prefix     "${prefix}/etc/LaunchDaemons/${launchd_label}"

    xinstall -m 755 -d "${destroot}${agents_path_prefix}"
    xinstall -m 755 -d "${destroot}${daemons_path_prefix}"

    foreach agent $agents {
        xinstall -m 644 "${worksrcpath}/LaunchAgents/$agent" "${destroot}${agents_path_prefix}/"
    }
    foreach daemon $daemons {
        xinstall -m 644 "${worksrcpath}/LaunchDaemons/$daemon" "${destroot}${daemons_path_prefix}/"
    }

    if {${startupitem.install} && [geteuid] == 0} {
        xinstall -d -m 0755 ${destroot}/Library/LaunchDaemons
        xinstall -d -m 0755 ${destroot}/Library/LaunchAgents
        foreach agent $agents {
            ln -s ${agents_path_prefix}/${agent} ${destroot}/Library/LaunchAgents
        }
        foreach daemon $daemons {
            ln -s ${daemons_path_prefix}/${daemon} ${destroot}/Library/LaunchDaemons
        }
    } else {
        foreach agent $agents {
            ln -sf ${agents_path_prefix}/${agent} ${destroot}${prefix}/etc/LaunchAgents
        }
        foreach daemon $daemons {
            ln -sf ${daemons_path_prefix}/${daemon} ${destroot}${prefix}/etc/LaunchDaemons
        }
    }
}
