PortSystem          1.0
PortGroup           github 1.0

github.setup        munki munki 3.6.0 v

name                munki-launchd
version             3.6.0
license             Apache-2
description         Managed software installation for macOS (launchd).
long_description    Munki is a set of tools that, used together with a webserver-based \
                    repository of packages and package metadata, can be used by macOS \
                    administrators to manage software installs (and in many cases removals) on \
                    macOS client machines.

checksums           rmd160  722828893a7a06bcd2cdb4f9d631072d33d39a27 \
                    sha256  c32fdb6d351444bf88cc0e0296dc2e43594def23e06f96937750f4661321f494 \
                    size    7442236

depends_run         port:munki-core

worksrcdir          "munki-${version}/launchd"

set agent_prefix com.googlecode.munki
set agents {com.googlecode.munki.ManagedSoftwareCenter.plist \
            com.googlecode.munki.MunkiStatus.plist \
            com.googlecode.munki.managedsoftwareupdate-loginwindow.plist \
            com.googlecode.munki.munki-notifier.plist}
set daemons {com.googlecode.munki.authrestartd.plist \
             com.googlecode.munki.logouthelper.plist \
             com.googlecode.munki.managedsoftwareupdate-check.plist \
             com.googlecode.munki.managedsoftwareupdate-install.plist \
             com.googlecode.munki.managedsoftwareupdate-manualcheck.plist}

use_configure       no

patch {
    foreach agent $agents {
        reinplace "s|/usr/local/munki/|/opt/local/bin/|g" LaunchAgents/$agent
        reinplace "s|/Applications/|/Applications/MacPorts/|g" LaunchAgents/$agent
    }
    foreach daemon $daemons {
        reinplace "s|/usr/local/munki/|/opt/local/bin/|g" LaunchDaemons/$daemon
        reinplace "s|/Applications/|/Applications/MacPorts/|g" LaunchDaemons/$daemon
    }
}

build {}

destroot {
    set launchd_label           org.macports.munki
    set agents_path_prefix      "${prefix}/etc/LaunchAgents/${launchd_label}"
    set daemons_path_prefix     "${prefix}/etc/LaunchDaemons/${launchd_label}"

    xinstall -m 755 -d "${destroot}${agents_path_prefix}"
    xinstall -m 755 -d "${destroot}${daemons_path_prefix}"

    foreach agent $agents {
        xinstall -m 644 "${worksrcpath}/LaunchAgents/$agent" "${destroot}${agents_path_prefix}/"
    }
    foreach daemon $daemons {
        xinstall -m 644 "${worksrcpath}/LaunchDaemons/$daemon" "${destroot}${daemons_path_prefix}/"
    }

    if {${startupitem.install} && [geteuid] == 0} {
        xinstall -d -m 0755 ${destroot}/Library/LaunchDaemons
        xinstall -d -m 0755 ${destroot}/Library/LaunchAgents
        foreach agent $agents {
            ln -s ${agents_path_prefix}/${agent} ${destroot}/Library/LaunchAgents
        }
        foreach daemon $daemons {
            ln -s ${daemons_path_prefix}/${daemon} ${destroot}/Library/LaunchDaemons
        }
    } else {
        foreach agent $agents {
            ln -sf ${agents_path_prefix}/${agent} ${destroot}${prefix}/etc/LaunchAgents
        }
        foreach daemon $daemons {
            ln -sf ${daemons_path_prefix}/${daemon} ${destroot}${prefix}/etc/LaunchDaemons
        }
    }
}
